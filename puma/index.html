<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" type="text/css" href="/css/grust.css" />
  <style>
    .cssHeaderRow { background-color: #9e9e9e; }
    .cssTableRow { background-color: #FAFBFC; }
    .cssOddTableRow { background-color: #F7F8F9; }
    .cssHoverTableRow { background: #ddd; }
    .cssHeaderCell { color: #FFFFFF; font-size: 20px; padding: 10px !important; border: solid 1px #FFFFFF; }
    .cssTableCell { font-size: 20px; padding: 10px !important; border: solid 1px #FFFFFF; text-align: center; }
    .cssRowNumberCell { text-align: center; }
  </style>
</head>

<body style="background-color: #d0d8e0;">
  <div style="background-color: #FFF; width:375px; margin: auto; ">
    <header style="background-color: #9e9e9e;">
      <p style="text-align: center; color: #FFFFFF; font-size: 20px; padding: 5px;">Журавлиное</p>
    </header>
    <div style="width: 375px; height: 200px;">
      <div id="chart_div_gaugetemp" style="width: 185px; height: 200px; text-align: center; float:left;"></div>
      <div id="div_text" style='font-family: "Lucida Console", Monospace; font-size:16px; color: #505050; width: 190px; height: 200px; text-align: center; float:left;'></div>
    </div>
    <div id="chart_div_linetemp" style="width: 375px; height: 240px;"></div>
    <footer style="background-color: #9e9e9e;">
      <p style="text-align: center; color: #FFFFFF; font-size: 20px; padding: 5px;">Журавлиное</p>
    </footer>
  </div>

<script type="text/javascript" src="/js/charts-loader.js"></script>
<script type="text/javascript">

  google.charts.load('current', {'packages':['corechart', 'gauge']});
  google.charts.setOnLoadCallback(drawLineWeek);

  function drawLineWeek() {
    /*
      по запросу XMLHttpRequest.open('GET', '/mlab', false) отсюда, со стороны клиента, 
      сервер server.js запросит из базы данных последние 18 записей и выдаст их клиенту:
    
      if (locator.pathname === '/mlab') {
        MongoClient.connect(config.mlabDB, {useNewUrlParser: true}, function(err, client) {
          var collection = client.db(config.dbName).collection('toksovo');
          collection.find({}).sort([['_id', -1]]).limit(18).toArray(function(err, docs) {
            res.end(JSON.stringify(docs));
            client.close();
          });
        });
      }
    */
    var timestampnow = Math.round(Date.now()/1000);
    var timestampfrom = timestampnow - 259200; // 60*60*72
    var sensorstext = '';
    var athomelast = 0.0;
    var amlab = [];
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/mlab', false);
    xhr.send();
    if (xhr.status != 200) {
      alert( xhr.status + ': ' + xhr.statusText );
    } else {
      amlab = JSON.parse(xhr.responseText);
      var minTemp = 0, maxTemp = 0;
      var adata = [[
        {label: 'Часы', type: 'number'},
        {label: 'Дом', type: 'number'},
        {label: 'Улица', type: 'number'}
      ]];
      for (var i = 0; i < amlab.length; i++) {
        // время, в часах, на оси абсцисс
        var itimestamp = parseFloat(amlab[i]._id);
        var hour = (itimestamp - timestampnow) / 3600; // 60*60
        if (hour < -72) continue;
        // температура на улице
        var outdoor = parseFloat(amlab[i].tout);
        // температура в доме, min значение датчиков
        var athome = parseFloat(amlab[i].data[0].val);
        if (!i) {
          // последний по времени замер
          athomelast = Number(amlab[i].data[0].val);
          var date = new Date(itimestamp * 1000);
          sensorstext += date.toLocaleString("ru", {month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric'}) + '<br>';
          sensorstext += 'На улице ' + amlab[i].tout + '&#176;C' + '<br>';
          sensorstext += 'В доме ' + amlab[i].data[0].val + '&#176;C' + '<br>';
          for (var j = 1; j < amlab[i].data.length; j++) {
            sensorstext += amlab[i].data[j].dev + ' ' + amlab[i].data[j].val + '<br>'
          }
        }
        // данные в массив для вывода в виде графика
        adata.push([hour, athome, outdoor]); 
        // min max температур для разметки оси ординат
        if (minTemp > athome) minTemp = athome;
        if (maxTemp < athome) maxTemp = athome;
        if (minTemp > outdoor) minTemp = outdoor;
        if (maxTemp < outdoor) maxTemp = outdoor;
      }
      // Text
      document.getElementById("div_text").innerHTML = sensorstext;
      // Gauge temperature at home
      var data = google.visualization.arrayToDataTable([['Label', 'Value'], ['Темп', athomelast]]);
      var chart = new google.visualization.Gauge(document.getElementById('chart_div_gaugetemp'));
      chart.draw(data, {
        min:0, max:20, width:185, height:185, minorTicks:5, 
        majorTicks:["0","5","10","15","20"]
      });
      // Chart 
      var majorTicks = [], iFrom = Math.round(minTemp/5), iTo = Math.round(maxTemp/5);
      for (var i = iFrom; i <= iTo; i++) majorTicks.push(5*i);
      var data = google.visualization.arrayToDataTable(adata);
      var options = {
        hAxis: {ticks: [-72,-48,-24,0], minorGridlines: {count: 5} },
        vAxis: {ticks: majorTicks, minorGridlines: {count: 4} },
//        chartArea: {left:75, right:150}, 
        chartArea: {left:30, right:10}, 
        curveType: 'function',
        colors: ['#CD5C5C', '#093871'],
        titleTextStyle: {color: '#707070' },
//        title: 'Последние 72 часа',
        fontSize: 14,
        titlePosition: 'out',
//        legend: {position: 'right', textStyle: {color: '#093871', fontSize: 20}}
//        legend: {position: 'top', textStyle: {color: '#093871', fontSize: 12}}
        legend: 'none'
      };
      var chart = new google.visualization.LineChart(document.getElementById('chart_div_linetemp'));
      chart.draw(data, options);
    }
  }
</script>

</body>
</html>
